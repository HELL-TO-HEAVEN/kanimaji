<html>
<head>
<title>Kanimaji</title>
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script src="jquery-2.2.2.min.js"></script>
<script src="jquery-ui-1.11.4/jquery-ui.min.js"></script>
<link rel="stylesheet" href="jquery-ui-1.11.4/jquery-ui.min.css">
<script language="JavaScript" type="text/javascript">

function svg_loaded() {
    var svg, root, num_strokes;
    svg = $(document.getElementById('mysvg').getSVGDocument())

    // allow the svg to grow
    root = svg.find('svg')[0]
    root.removeAttribute('width')
    root.removeAttribute('height')
    
    num_strokes = svg.find('[data-num-strokes]').data('num-strokes')
    $("#stroke").spinner({max: num_strokes})
}

/* 
    Clears everything, sets the stroke-th stroke to drawn/drawing,
    and returns the time the animation will last (if any).
*/
function animate_stroke(stroke) {
    var svg, cls, stroke, els, selector, factor, duration, new_duration;

    svg = $(document.getElementById('mysvg').getSVGDocument());

    /* cleanup all classes and durations, if necessary */
    svg.find('[data-stroke]')
        .removeClass('animate current brush backward')
        .css("animation-duration", '');

    /*
        Build class list from settings:
            "current"  - for marking last drawn/drawing stroke,
                         so that subsequent strokes will be blank.
            "animate"  - for animating the stroke.
            "backward" - for making the animation backward.
            "brush"    - for showing the brush (the fatty drawing circle).
    */
    cls = 'current';
    if($('#animate').is(":checked"))
        cls += ' animate';
    if($('#backward').is(":checked"))
        cls += ' backward';
    if($('#brush').is(":checked"))
        cls += ' brush';

    /*
        hack, trigger reflow to force animation restart, not necessary unless
        animating again the same stroke, and want the animation to be restarted.
    */
    svg.find('svg')[0].offsetWidth;

    /* add classes to animating elaments */
    selector = '[data-stroke="' + stroke + '"]';
    els = svg.find(selector).addClass(cls);

    /* set custom speed, if selected */
    duration = svg.find(selector+'[data-duration]').data("duration");
    if($('#set_speed').is(":checked")) {
        duration *= Math.exp(-$('#speed').slider("value") * 2.0/100);
        els.css("animation-duration", duration+'s');
    }
    return duration;
}

function kill_animation_timeout() {
    if(window.animator_timeout) {
        clearTimeout(window.animator_timeout);
        delete window.animator_timeout;
    }
}

function animate_selected_stroke() {
    kill_animation_timeout();
    animate_stroke($("#stroke").spinner("value"));
}

function animate_strokes() {
    var svg, num_strokes, animator_loop;

    svg = $(document.getElementById('mysvg').getSVGDocument());
    num_strokes = svg.find('[data-num-strokes]').data('num-strokes');

    kill_animation_timeout();

    /* setup the animating function */
    animator_loop = function(stroke) {
        var next_stroke, duration;

        if($('#backward').is(":checked")) {
            next_stroke = (stroke + num_strokes - 1) % num_strokes;
            duration = animate_stroke((stroke - 2 + num_strokes) % num_strokes + 1);
        }
        else {
            next_stroke = stroke % num_strokes + 1;
            duration = animate_stroke(stroke);
        }

        window.animator_timeout = setTimeout(function(){
            animator_loop(next_stroke); 
        }, duration * 1000);
    }
    
    /* start the animation */
    animator_loop(1);
}

$(function() {
    $("#backward, #brush, #animate, #set_speed,"+
        " #draw, #animate_strokes, #stop_animation").button();
    $("#stroke").spinner({
            min: 0
        });
    $("#speed").slider({
            min: -100,
            max: 100,
            value: 0,
            disabled: !$('#set_speed').is(":checked")
        });
    $('#set_speed').change(function() {
            $("#speed").slider({disabled: !$(this).is(":checked")})
        });
    $("#draw").click(animate_selected_stroke);
    $("#animate_strokes").click(animate_strokes);
    $("#stop_animation").click(kill_animation_timeout);
})
</script>
<style>
</style>
</head>
<body style="text-align: center">
<h1 style="font-family: Sans; margin-bottom: 0.3em">Kanimaji</h1>
Visit the <a href="https://github.com/maurimo/kanimaji">project page on GitHub</a>.
<table style="margin: 0 auto">
<tr><td>
<div style="width: 300; height: 300; text-align: center; margin: 0 auto">
<object>
   <embed id="mysvg" src="samples/084b8_js_anim.svg"
            onload="javascript:svg_loaded()">
</object>
</div>
</td><td style="font-size: 80%">
<p>
    <input type="checkbox" id="backward">
    <label for="backward">Backward</label>
    <input type="checkbox" id="brush" checked="1">
    <label for="brush">Show brush</label>
    <input type="checkbox" id="animate" checked="1">
    <label for="animate">Animate</label>
</p>
<p>
    <span id="speed" style="width: 160; display: inline-block; margin: 0em 0.5em"></span>
    <input type="checkbox" id="set_speed"/>
    <label for="set_speed">Set speed</label>
</p>
<hr>
<p>
    <button id="draw" style="color: red">Draw stroke!</button>
    &nbsp;<label for="stroke" class="ui-widget ui-state-default"
        style="border:none; background: none;">Stroke:</label>
    <input id="stroke" name="value" value="1" style="width: 3em"/>
</p>
<p>
<button id="animate_strokes" style="color: red">Animate strokes!</button>
<button id="stop_animation" style="color: red">Stop animation</button>
</p>
</td></tr></table>
<div style="text-align: left; margin-left: 1em; font-family: Sans; font-size: 120%">
To activate the animation on the 4th stroke it is sufficient to do (you can test in the Javascript console):
</div>
<div style="text-align: left; margin-left: 1em; padding-left: 1em; border-left: 2px solid #888;">
<pre style='color:#000000;background:#ffffff;'>svg <span style='color:#808030; '>=</span> $<span style='color:#808030; '>(</span>document<span style='color:#808030; '>.</span>getElementById<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>mysvg</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>getSVGDocument<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
svg<span style='color:#808030; '>.</span>find<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>[data-stroke="4"]</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>addClass<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>animate brush current</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
</pre>
</div>
<div style="text-align: left; margin-left: 1em; font-family: Sans; font-size: 120%">
(We included jQuery for convenience, but it is not necessary).<br>
The code activating the animation of the n-th stroke using the settings is just:
</div>
<div style="text-align: left; margin-left: 1em; padding-left: 1em; border-left: 2px solid #888;">
<!-- Generated by https://tohtml.com/ -->
<pre style='color:#000000;background:#ffffff;'><span style='color:#696969; '>/* </span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;Clears everything, sets the stroke-th stroke to drawn/drawing,</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;and returns the time the animation will last (if any).</span>
<span style='color:#696969; '>*/</span>
<span style='color:#800000; font-weight:bold; '>function</span> animate_stroke<span style='color:#808030; '>(</span>stroke<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
    <span style='color:#800000; font-weight:bold; '>var</span> svg<span style='color:#808030; '>,</span> cls<span style='color:#808030; '>,</span> stroke<span style='color:#808030; '>,</span> els<span style='color:#808030; '>,</span> selector<span style='color:#808030; '>,</span> factor<span style='color:#808030; '>,</span> duration<span style='color:#808030; '>,</span> new_duration<span style='color:#800080; '>;</span>

    svg <span style='color:#808030; '>=</span> $<span style='color:#808030; '>(</span>document<span style='color:#808030; '>.</span>getElementById<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>mysvg</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>getSVGDocument<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

    <span style='color:#696969; '>/* cleanup all classes and durations, if necessary */</span>
    svg<span style='color:#808030; '>.</span>find<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>[data-stroke]</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span>
        <span style='color:#808030; '>.</span>removeClass<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>animate current brush backward</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span>
        <span style='color:#808030; '>.</span>css<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>animation-duration</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> <span style='color:#800000; '>'</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

    <span style='color:#696969; '>/*</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;Build class list from settings:</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;"current"  - for marking last drawn/drawing stroke,</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;so that subsequent strokes will be blank.</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;"animate"  - for animating the stroke.</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;"backward" - for making the animation backward.</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;"brush"    - for showing the brush (the fatty drawing circle).</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;*/</span>
    cls <span style='color:#808030; '>=</span> <span style='color:#800000; '>'</span><span style='color:#0000e6; '>current</span><span style='color:#800000; '>'</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>$<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>#animate</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>is<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>:checked</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
        cls <span style='color:#808030; '>+=</span> <span style='color:#800000; '>'</span><span style='color:#0000e6; '> animate</span><span style='color:#800000; '>'</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>$<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>#backward</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>is<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>:checked</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
        cls <span style='color:#808030; '>+=</span> <span style='color:#800000; '>'</span><span style='color:#0000e6; '> backward</span><span style='color:#800000; '>'</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>$<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>#brush</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>is<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>:checked</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span>
        cls <span style='color:#808030; '>+=</span> <span style='color:#800000; '>'</span><span style='color:#0000e6; '> brush</span><span style='color:#800000; '>'</span><span style='color:#800080; '>;</span>

    <span style='color:#696969; '>/*</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;hack, trigger reflow to force animation restart, not necessary unless</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;animating again the same stroke, and want the animation to be restarted.</span>
<span style='color:#696969; '>&#xa0;&#xa0;&#xa0;&#xa0;*/</span>
    svg<span style='color:#808030; '>.</span>find<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>svg</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>offsetWidth<span style='color:#800080; '>;</span>

    <span style='color:#696969; '>/* add classes to animating elaments */</span>
    selector <span style='color:#808030; '>=</span> <span style='color:#800000; '>'</span><span style='color:#0000e6; '>[data-stroke="</span><span style='color:#800000; '>'</span> <span style='color:#808030; '>+</span> stroke <span style='color:#808030; '>+</span> <span style='color:#800000; '>'</span><span style='color:#0000e6; '>"]</span><span style='color:#800000; '>'</span><span style='color:#800080; '>;</span>
    els <span style='color:#808030; '>=</span> svg<span style='color:#808030; '>.</span>find<span style='color:#808030; '>(</span>selector<span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>addClass<span style='color:#808030; '>(</span>cls<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>

    <span style='color:#696969; '>/* set custom speed, if selected */</span>
    duration <span style='color:#808030; '>=</span> svg<span style='color:#808030; '>.</span>find<span style='color:#808030; '>(</span>selector<span style='color:#808030; '>+</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>[data-duration]</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>data<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>duration</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>$<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>#set_speed</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>is<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>:checked</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
        duration <span style='color:#808030; '>*=</span> <span style='color:#797997; '>Math</span><span style='color:#808030; '>.</span><span style='color:#800000; font-weight:bold; '>exp</span><span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>$<span style='color:#808030; '>(</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>#speed</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>slider<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>value</span><span style='color:#800000; '>"</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>*</span> <span style='color:#008000; '>2.0</span><span style='color:#808030; '>/</span><span style='color:#008c00; '>100</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
        els<span style='color:#808030; '>.</span>css<span style='color:#808030; '>(</span><span style='color:#800000; '>"</span><span style='color:#0000e6; '>animation-duration</span><span style='color:#800000; '>"</span><span style='color:#808030; '>,</span> duration<span style='color:#808030; '>+</span><span style='color:#800000; '>'</span><span style='color:#0000e6; '>s</span><span style='color:#800000; '>'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
    <span style='color:#800080; '>}</span>
    <span style='color:#800000; font-weight:bold; '>return</span> duration<span style='color:#800080; '>;</span>
<span style='color:#800080; '>}</span>
</pre>
</div>
</body>
</html>